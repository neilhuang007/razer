package me.neilhuang007.razer.module.impl.exploit.disabler;

import me.neilhuang007.razer.component.impl.player.BadPacketsComponent;
import me.neilhuang007.razer.component.impl.player.BlinkComponent;
import me.neilhuang007.razer.module.impl.exploit.Disabler;
import me.neilhuang007.razer.newevent.Listener;
import me.neilhuang007.razer.newevent.annotations.EventLink;
import me.neilhuang007.razer.newevent.impl.motion.PreMotionEvent;
import me.neilhuang007.razer.newevent.impl.other.WorldChangeEvent;
import me.neilhuang007.razer.newevent.impl.packet.PacketSendEvent;
import me.neilhuang007.razer.newevent.impl.render.Render2DEvent;
import me.neilhuang007.razer.util.chat.ChatUtil;
import me.neilhuang007.razer.value.Mode;
import me.neilhuang007.razer.value.impl.BooleanValue;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C03PacketPlayer;
import util.time.StopWatch;

public class RiseBalanceDisabler extends Mode<Disabler> {

    private BooleanValue resetOnWorldChange = new BooleanValue("Reset On World Change", this, false);
    private BooleanValue forceLowTimer = new BooleanValue("Force low timer when Balance is below 0", this, false);
    private BooleanValue display = new BooleanValue("Display", this, false);
    private BooleanValue pulse = new BooleanValue("Pulse", this, false);
    private BooleanValue onlyWhenStill = new BooleanValue("Only Still", this, false);

    private double balance = 0;
    private final StopWatch stopWatch = new StopWatch();
    private final StopWatch lastSend = new StopWatch();


    public RiseBalanceDisabler(String name, Disabler parent) {
        super(name, parent);
    }

    @Override
    public void onEnable() {
        this.reset();
    }

    @Override
    public void onDisable() {
        BlinkComponent.blinking = false;
    }

    @EventLink()
    public final Listener<PacketSendEvent> onPacketSend = event -> {
        Packet<?> packet = event.getPacket();

        if (packet instanceof C03PacketPlayer) {
            C03PacketPlayer c03PacketPlayer = ((C03PacketPlayer) packet);

            if (!c03PacketPlayer.getRotating() && !c03PacketPlayer.isMoving() && !BadPacketsComponent.bad() &&
                    (!onlyWhenStill.getValue() || (mc.thePlayer.posX == mc.thePlayer.lastTickPosX && mc.thePlayer.posY == mc.thePlayer.lastTickPosY && mc.thePlayer.posZ == mc.thePlayer.lastTickPosZ))) {
                event.setCancelled(true);
            }

            // We use this instead of an else because some other modules might cancel c03s
            if (!event.isCancelled() || BlinkComponent.blinking) {
                this.balance -= 50;
            }

            this.balance += stopWatch.getElapsedTime();
            this.stopWatch.reset();
        }
    };

    @EventLink()
    public final Listener<PreMotionEvent> onPreMotionEvent = event -> {
        if (mc.thePlayer.ticksExisted % 20 == 0 && this.display.getValue()) {
            ChatUtil.display("Balance: " + this.balance);
        }

        if (this.pulse.getValue() && mc.timer.timerSpeed > 1) {
            BlinkComponent.blinking = true;
            if (lastSend.finished(50 * 9)) {
                lastSend.reset();
                BlinkComponent.dispatch();
            }
        }
    };

    @EventLink()
    public final Listener<WorldChangeEvent> onWorldChange = event -> {
        if (this.resetOnWorldChange.getValue()) {
            this.reset();
            this.balance = 0;
        }
    };

    private void reset() {
        this.balance = 0;
        this.stopWatch.reset();
    }

    @EventLink()
    public final Listener<Render2DEvent> onRender2D = event -> {
        if (this.forceLowTimer.getValue() && this.balance < 200) {
            mc.timer.timerSpeed = this.balance < 0 ? 0.5f : 1;
        }
    };
}